
create table user_kposminin.la_yaca_ccall_20161103 as
select
  ymd,
  phone_num,
  max(label) as label,
  max(first_day) as first_day,
  max(max_score) as max_score,
  concat_ws(' ',
    collect_list(
      concat(section_ind,':',1)
    )
  ) as feat_1,
  concat_ws(' ',
    collect_list(
      concat(section_ind,':',cnt)
    )
  ) as feat_cnt,
  concat_ws(' ',
    collect_list(
      concat(section_ind,':',max_score)
    )
  ) as feat_max_score,
  concat_ws(' ',
    collect_list(
      concat(section_ind,':',avg_score)
    )
  ) as feat_avg_score,
  concat_ws(' ',
    collect_list(
      concat(section_ind,':',avg_tic)
    )
  ) as feat_avg_tic
from
  (select
    v.ymd,
    b.contact_str as phone_num,
    max(if(p.id is Null,0,1)) as label,
    max(if(p.first_day = 1, 1, 0)) as first_day,
    y.section_ind,
    max(t.score) as max_score,
    avg(t.score) as avg_score,
    count(*) as cnt,
    avg(y.tic) as avg_tic
  from
    prod_features_liveinternet.visits_r v
    left join user_kposminin.yaca_urlfr y on y.urlfr = v.urlfr
    left join prod_features_liveinternet.urlfr_tgt_cnt_cumulative2 t on t.urlfr = v.urlfr
    inner join (select uid_str,h_uid_rk from prod_dds.h_uid where load_src = 'LI.02') d on d.uid_str = v.id
    inner join (select h_contact_rk, h_uid_rk from prod_dds.l_uid_contact where contact_type_cd = 'PHONE') c on d.h_uid_rk = c.h_uid_rk
    inner join (select h_contact_rk, contact_str from prod_dds.h_contact where contact_type_cd = 'PHONE') b on b.h_contact_rk = c.h_contact_rk  
    left join (  
       select id, if(ymd = '2016-11-04',1,0) as first_day from prod_features_liveinternet.user_action 
        where ymd between '2016-11-04' and '2016-11-06'
          and action_type = 'tinkoff_platinum_complete_application'
    ) p on p.id = v.id
  where
    t.ymd = '2016-09-18' and 
    t.target = 'tinkoff_platinum_complete_application@tinkoff_action' and
    (t.cnt_total > 300000 or t.cnt_positive > 30) and 
    v.ymd = '2016-11-03'
  group by  
    v.ymd,
    b.contact_str,
    y.section_ind
  sort by
    v.ymd,
    b.contact_str,
    y.section_ind
  ) a
group by ymd,phone_num;
;











