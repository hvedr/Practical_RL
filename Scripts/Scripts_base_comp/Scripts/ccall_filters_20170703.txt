create table user_kposminin.ccall_filtered (
   phone_num string,
         ymd string,
   load_dttm timestamp)
 partitioned by (type string)
;

insert overwrite table user_kposminin.ccall_filtered partition (type)
select if(substr(b.mobile_telephone_no,1,1)=8, concat("+7",substr(b.mobile_telephone_no,2,20)),b.mobile_telephone_no) as phone_num
     , b.first_ccr_dt as ymd
     , current_timestamp as load_dttm
     , 'customer' as type
  from prod_emart.customer b 
 inner join prod_emart.financial_account d on b.customer_rk = d.customer_rk
 where d.financial_account_type_cd in ('CCR', 'COR', 'LON')
     ;

insert overwrite table user_kposminin.ccall_filtered partition (type)
select if(substr(t1.mobile_telephone_no,1,1)=8, concat("+7",substr(t1.mobile_telephone_no,2,20)),t1.mobile_telephone_no) as phone_num
     , date_add(t1.decision_dt,-2) as ymd
     , current_timestamp as load_dttm
     , 'applicant' as type
  from prod_emart.FINANCIAL_ACCOUNT_APPLICANT t1 
 inner join prod_emart.financial_account_application t2 ON (t2.financial_application_rk = t1.financial_application_rk)
 where (not mobile_telephone_no is Null)
   and t2.financial_producT_type_cd in ('CCR','LON','COR', 'IPO')
     ;

insert overwrite table user_kposminin.ccall_filtered partition (type)
select if(substr(b.phone_mobile,1,1)=8, concat("+7",substr(b.phone_mobile,2,20)),b.phone_mobile) as phone_num
     , create_dt as ymd
     , current_timestamp as load_dttm
     , 'called_6m' as type
  from prod_emart.short_applications_current b
 where cast(create_dt as date) > date_add('2017-03-01',- 178)
     ;




proc sql;
create table hd_bds.cold_liru_call as 
select
  put(datepart(create_dt),YYMMDD10.) as ymd,
  b.phone_mobile,
  b.utm_campaign,
  b.hl_rk,  
  case when status = 'В работе' then 1 else 0 end as in_work,
  case when a.financial_application_rk is not Null then 1 else 0 end as full_app,
  case when a.decision_dt is not Null then 1 else 0 end as considered,
  case when a.decision_approve_dt is not Null then 1 else 0 end as approve,
  case when a.utilization_dt is not Null then 1 else 0 end as utilization
  
from emart.short_applications_current b 
  inner join emart.financial_account_application a on b.financial_application_rk = a.financial_application_rk
where (not b.status in ('Дубль', 'Черный список'))
 and (a.financial_application_rk is not Null)
 and (b.phone_mobile is not Null)
 and b.utm_campaign like 'cold_liru%'
 and create_dt >= '05Mar2017:0:0:0'dt 
 
;
quit;



create table user_kposminin.ccall_liru_filter_analysis_2 as 
select a.phone_num, 
       max(a.segment_nm) as segment_nm,
       max(a.seg_score) as seg_score,
       a.ymd, 
       concat_ws(',',collect_set(b.type)) as filter_type,
       max(if(c.phone_mobile is Null,0,1)) as called_flg,
       min(c.ymd) as call_ymd,
       max(c.approve) as  approve
  from prod_ccall.prod_segments a
  left join user_kposminin.ccall_filtered b on a.phone_num = b.phone_num
  left join prod_ccall.cold_liru_call c on substr(c.phone_mobile,2,20) = substr(a.phone_num,3,20)
 where a.ymd between nvl(date_add(c.ymd,-8),'2000-01-01') and nvl(date_add(c.ymd,-1),'2999-01-01')
   and nvl(c.utm_campaign, 'cold_liru') = 'cold_liru'
   and a.ymd > nvl(b.ymd,'2000-01-01')
 group by a.phone_num, a.ymd
;
   
   
 тестовые сегменты
 	выгружено	отфильтровано	отзвонено
	579395	196542	88329

 боевые сегменты
 	выгружено	отфильтровано	отзвонено
	804474	250880	62550

  

-- мало джойнов на отфильтрованные и отзвоненные номера. Половина номеров непонятно как не попала.