id_cred_scor_test_20170429


aza_to_scoring_liru_id
phone_mobile (varchar(147))
id (string)
load_src (string)
drop table user_kposminin.cred_scor_calc_debug_id_20170429;

-- ќтлавливаем ошибку расчета факторов по кукам: расхождение между результатами скриптов aza и accum_store

-- берем полные за€вки за 2017-04-29. строим старым способом (aza_test) и сравниваем с новым: user_kposminin.id_cred_scor_test_20170429 - размеченные куки с новыми факторами (из accum_store)

drop table user_kposminin.cred_scor_calc_debug_id_20170429;


create table user_kposminin.cred_scor_calc_debug_id_20170429 as 
select a.* ,m.id,m.load_src
from user_kposminin.full_app_201704 a
left semi join user_kposminin.id_cred_scor_test_20170429 b on b.phone_mobile = a.phone_mobile
inner join 
      (select 
         uid_str as id,
         property_value as phone_num,
         load_src
       from
         prod_dds.md_uid_property 
       where
         property_cd = 'PHONE'
      ) m on substr(m.phone_num,3,20) = substr(a.phone_mobile,2,20)
where a.ymd = '2017-04-29'
;


create table user_kposminin.visits_cred_scor_calc_debug_20170429 like user_kposminin.ccall_visits_aza_test_20170309;


insert overwrite 
 table user_kposminin.visits_cred_scor_calc_debug_20170429 partition(ymd)
select
  a.phone_mobile
 ,a.ymd as call_ymd
 ,v.id
 ,v.url_fragment as urlfr
 ,v.visit_count as cnt
 ,v.duration_sec as duration
 ,v.average_visit_hour as avg_hour
 ,v.ymd
 
from
  user_kposminin.cred_scor_calc_debug_id_20170429 a  
  inner join prod_odd.visit_feature v on v.id = a.id and v.load_src = a.load_src
where
  v.ymd = '#visit_ymd'
;



create table user_kposminin.cred_scor_calc_debug_20170429_1 as
select 
  phone_mobile, 
  call_ymd,
  (unix_timestamp(max(ymd), 'yyyy-MM-dd') - unix_timestamp(min(ymd), 'yyyy-MM-dd'))/60/60/24 as ymd_range,
  stddev(unix_timestamp(ymd, 'yyyy-MM-dd')/60/60 + avg_hour) as time_std,
  count(distinct ymd) as ymd_cnt,
  count(distinct id) as id_cnt,
  avg(avg_hour) as avg_hour,
  percentile_approx(avg_hour,0.1) as avg_hour_q10,
  percentile_approx(avg_hour,0.9) as avg_hour_q90,
  urlfr,
  count(*) as cnt,
  sum(cnt) as hits,
  avg(duration) as avg_duration
from 
  user_kposminin.visits_cred_scor_calc_debug_20170429  v
where
  call_ymd > ymd and call_ymd < date_add(ymd,60)
group by
  phone_mobile, 
  call_ymd,
  urlfr
;

create table user_kposminin.cred_scor_calc_debug_20170429_2 as 
  select 
     v.phone_mobile,     
     v.call_ymd,
     v.urlfr,
     log((t1.cnt_positive + 1)/(t1.cnt_total - t1.cnt_positive + 1)) as score1,
     t2.score as score2,
     t3.score as score3,
     v.cnt,
     v.hits,
     v.avg_duration,
     v.time_std, 
     v.ymd_range, 
     v.avg_hour,
     v.avg_hour_q10, 
     v.avg_hour_q90, 
     v.ymd_cnt,
     substr(y.section_ind, 0, 6) as yaca_ind   
  from
     user_kposminin.cred_scor_calc_debug_20170429_1 v
     left join user_kposminin.urlfr_tgt_cnt_ccall_20161201 t1 on t1.urlfr = v.urlfr
     left join (
       select urlfr,score from prod_features_liveinternet.urlfr_tgt_cnt_cumulative2
       where ymd = '2017-01-15' and target = 'tinkoff_platinum_approved_application03@tinkoff_action'
       and (cnt_total > 30000 or cnt_positive > 10)) t2 on t2.urlfr = v.urlfr
     left join (
       select urlfr,score from prod_features_liveinternet.urlfr_tgt_cnt_cumulative2
       where ymd = '2017-01-15' and target = 'tinkoff_platinum_complete_application03@tinkoff_action'
       and (cnt_total > 30000 or cnt_positive > 10)) t3 on t3.urlfr = v.urlfr
     left join user_kposminin.yaca_urlfr y on y.urlfr = v.urlfr

;


create table user_kposminin.cred_scor_calc_debug_20170429_3 as 
select
  phone_mobile                   as phone_mobile,
  call_ymd                       as call_ymd, 
  yaca_ind                       as yaca_ind,
  sum(cnt)                       as visits_cnt
from user_kposminin.cred_scor_calc_debug_20170429_2 a
group by
  phone_mobile, call_ymd, yaca_ind 
;


create table user_kposminin.cred_scor_calc_debug_20170429_4 as 
select
  phone_mobile                   as phone_mobile,
  call_ymd                       as call_ymd, 
  sum(cnt)                       as visits_cnt
from user_kposminin.cred_scor_calc_debug_20170429_2 a
group by
  phone_mobile, call_ymd
;


-- «десь не хочет считать. ѕомогает, если таблицу user_kposminin.cc_sc_tr_2_t  хранить в формате bzip2 и выставить настройки :


create table user_kposminin.cred_scor_calc_debug_20170429_5 as 
select 
  phone_mobile as phone_mobile, 
  call_ymd as call_ymd, 
  count(*) as cnt, 
  sum(cnt) as visits_cnt, 
  sum(hits) as hits, 
  avg(avg_duration) as avg_duration, 
  avg(time_std) as avg_time_std, 
  avg(ymd_range) as avg_ymd_range, 
  avg(ymd_cnt) as avg_ymd_cnt, 
  avg(avg_hour) as avg_hour, 
  avg(avg_hour_q10) as avg_hour_q10, 
  avg(avg_hour_q90) as avg_hour_q90, 
  max(score1) as max_score1, 
  avg(score1) as avg_score1, 
  percentile_approx(score1,array(0.95,0.9,0.7,0.5,0.3)) as q_arr_score1, 
  max(score2) as max_score2, 
  avg(score2) as avg_score2, 
  percentile_approx(score2,array(0.95,0.9,0.7,0.5,0.3)) as q_arr_score2, 
  max(score3) as max_score3,
  avg(score3) as avg_score3, 
  percentile_approx(score3,array(0.95,0.9,0.7,0.5,0.3)) as q_arr_score3 
from user_kposminin.cred_scor_calc_debug_20170429_2 a 
group by a.phone_mobile, a.call_ymd
;



create table user_kposminin.cred_scor_calc_debug_20170429_5_part2 as 
select 
  phone_mobile as phone_mobile, 
  call_ymd as call_ymd, 
  sum(if(urlfr like 'e.mail.ru%',1,0)) as emailru,
  sum(if(urlfr like 'm.%',1,0))/sum(1) as mobile_share,
  sum(if(urlfr rlike '^(m\\.)?vk.com%', 1, 0))/sum(1) as vk_share,
  sum(if(urlfr like 'vk.com%' or urlfr rlike '^(m\\.)?ok\\.ru' or urlfr like 'm.odnoklassniki.ru%' or urlfr rlike '^(m\\.)?my.mail.ru',1,0))/sum(1) as social_share,

  sum(if(avg_hour >= 9 and avg_hour <= 20,cnt,0))/sum(1) as work_hours_hits_share,
  stddev(avg_hour) as hour_std,  
  count( if(score1 > 1, urlfr,Null))/sum(1) as good_urlfr_share_score1,
  count( if(score2 > -7, urlfr,Null))/sum(1) as good_urlfr_share_score2,
  count( if(score3 > -7, urlfr,Null))/sum(1) as good_urlfr_share_score3,
  avg( if(score1 > 1, time_std ,Null)) as good_urlfr_timestd_score1,
  max(
             named_struct(
             'score1', score1,
             'time_std', time_std
             )           
     ).time_std as max_urlfr_time_std_1
from user_kposminin.cred_scor_calc_debug_20170429_2 a 
group by a.phone_mobile, a.call_ymd
;




create table user_kposminin.cred_scor_calc_debug_20170429_6 as 
select
  b.phone_mobile                 as phone_mobile,
  b.call_ymd                     as call_ymd, 
  concat_ws(" ",sort_array(collect_list(concat(b.yaca_ind,":",format_number(b.visits_cnt/greatest(c.visits_cnt,cast(1 as bigint)),5))))) as yaca_str
  
from user_kposminin.cred_scor_calc_debug_20170429_3 b 
  left join user_kposminin.ccall_sc_aza_20170309_5 c on c.phone_mobile = b.phone_mobile and c.call_ymd = b.call_ymd
group by
  b.phone_mobile, b.call_ymd ;




create table user_kposminin.cred_scor_calc_debug_20170429_scoring as
select
  a.*,
  c.emailru, 
  c.mobile_share, 
  c.vk_share, 
  c.social_share,
  c.work_hours_hits_share, 
  c.hour_std, 
  c.good_urlfr_share_score1, 
  c.good_urlfr_share_score2, 
  c.good_urlfr_share_score3, 
  c.good_urlfr_timestd_score1, 
  c.max_urlfr_time_std_1, 
  b.yaca_str
from
  user_kposminin.cred_scor_calc_debug_20170429_5 a
  left join user_kposminin.cred_scor_calc_debug_20170429_6 b on b.phone_mobile = a.phone_mobile and b.call_ymd = a.call_ymd
  left join user_kposminin.cred_scor_calc_debug_20170429_5_part2 c on c.phone_mobile = a.phone_mobile and c.call_ymd = a.call_ymd
;




