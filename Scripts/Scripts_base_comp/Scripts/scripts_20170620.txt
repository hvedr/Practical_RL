

create table user_kposminin.urlfr_scores_threshold_tst as
  select 
    v.id, 
    v.load_src,
    max(m.phone_num) as phone_num,
    max(if(u.id is Null,0,1)) as label, 
    max(t1.coeff) as score1, 
    max(t2.coeff) as score2,
    max(t3.coeff) as score3 
  from
   
   (select id, load_src, url_fragment from prod_odd.visit_feature where ymd = '2017-06-13') v
   left join     (select 
       uid_str as id,
       property_value as phone_num,
       load_src
     from
       prod_dds.md_uid_property 
     where
       property_cd = 'PHONE'
    ) m on v.id = m.id and v.load_src = m.load_src
   left join 
    (
      select id
      from prod_features_liveinternet.user_action 
      where ymd between '2017-06-13' and date_add('2017-06-13',3)
      and action_type = 'tinkoff_platinum_approved_application'
    ) u on u.id = v.id
   left join dds_dic. max_coeff_url_fragment_score t1 on t1.url_fragment = v.url_fragment and t1.segment_nm = 'la_apppr_ccall_2_1'
   left join dds_dic. max_coeff_url_fragment_score t2 on t2.url_fragment = v.url_fragment and t2.segment_nm = 'la_apppr_ccall_2'
   left join dds_dic. max_coeff_url_fragment_score t3 on t3.url_fragment = v.url_fragment and t3.segment_nm = 'la_stand_ccall_2'

   group by
    v.id, v.load_src
 
; 
 

create table big_data_science.cold_liru_threshold_test as
select 
  wu_rk as phone_num,
  probability as score,
  segment_nm,
  ymd
from
  prod_ex_machina.user_segment
where
  ymd = '2017-06-20'
  and (
    (segment_nm = 'la_apppr_ccall_2_1' and probability > -8.44) -- 101878
    or (segment_nm = 'la_apppr_ccall_2' and probability > -7.34) -- 88181
    or (segment_nm = 'la_stand_ccall_2' and probability > -7.4)  -- 89879
      )
;

 
 